<krpano>
	<include url="./plugins/showtext.xml" />
	<!-- 引入皮肤 -->
	<!-- <include url="./plugins/videointerface.xml" /> -->
	<!-- 	
	<image>
		<sphere url='./imgs/preview1.jpeg' />
	</image> -->

	<scene name="videoscene" keep="true" autoload="true">
		<image>
			<sphere url="plugin:video" />
		</image>
	</scene>

	<scene name="imgscene" keep="true">
		<image>
			<sphere url="./imgs/preview1.jpeg" />
		</image>
	</scene>

	<scene name="noscene" keep="true">
		<image>
			<sphere />
		</image>
	</scene>

	<plugin name="video"
		pausedonstart="true"
		loop="true"
		volume="1.0"
	 />

	<view hlookat="0" vlookat="0" fovtype="DFOV" fov="130" fovmin="75" fovmax="150" distortion="0.0" />


	<!-- the action for dragging the hotspot - call it once in the ondown event -->
	<action name="draghotspot">
		if(flag == 'hotspot',
		spheretoscreen(ath, atv, hotspotcenterx, hotspotcentery, calc(mouse.stagex LT stagewidth/2 ? 'l' : 'r'));
		sub(drag_adjustx, mouse.stagex, hotspotcenterx);
		sub(drag_adjusty, mouse.stagey, hotspotcentery);
		asyncloop(pressed,
			sub(dx, mouse.stagex, drag_adjustx);
			sub(dy, mouse.stagey, drag_adjusty);
			screentosphere(dx, dy, ath, atv);
		),
		sub(drag_adjustx, mouse.stagex, x);
		sub(drag_adjusty, mouse.stagey, y);
		asyncloop(pressed,
			sub(x, mouse.stagex, drag_adjustx);
			sub(y, mouse.stagey, drag_adjusty);
		);
		);
		trace('name:',name,',flag:',flag);
	</action>


	<!-- 预览模式下有点击效果，编辑模式下拖动效果 -->
	<action name="ondownfn" scope="global">
		if(ispreview AND flag == 'hotspot' AND flag == 'image',set(hotspot[get(name)].url,get(hotspot[get(name)].triggering)));
		if(ispreview AND flag == 'layer' AND flag == 'image',set(layer[get(name)].url,get(layer[get(name)].triggering)));
		def(b, string, tolower('vCCCAA'));
		if(!ispreview,
			txtadd(bordername, 'border_', get(name));
			set(plugin[get(bordername)].visible, true);
		<!-- 放弃了，inlinefunction无法调用 -->
		<!-- for(set(i,0), i LT layer.count, inc(i), 
			trace(get(b)); -->
		<!-- trace(contains(get((layer[get(i)].name),'border_')); -->
		<!-- if(indexof((layer[get(i)].name,'border_') !=-1  AND layer[get(i)].name == get(bordername),set(layer[get(bordername)].visible, true));
			if(indexof((layer[get(i)].name,'border_') !=-1  AND layer[get(i)].name !== get(bordername),set(layer[get(bordername)].visible, false)); -->
		<!-- ); -->
		draghotspot()
		);
		js(hotspotClick(get(name)));
	</action>

	<action name="onupfn">
		if(ispreview AND flag == 'hotspot' AND flag == 'image',set(hotspot[get(name)].url,get(hotspot[get(name)].beforeTrigger)));
		if(ispreview AND flag == 'layer' AND flag == 'image',set(layer[get(name)].url,get(layer[get(name)].beforeTrigger)));
	</action>

	<!-- 热点上添加文本 -->
	<action name="add_all_the_time_tooltip">
		txtadd(tooltipname, 'tooltip_', get(name));
		callwhen(!plugin[get(tooltipname)],
			addplugin(get(tooltipname));
			if(flag == 'hotspot',
				txtadd(plugin[get(tooltipname)].parent, 'hotspot[', get(name), ']'),
				txtadd(plugin[get(tooltipname)].parent, 'layer[', get(name), ']');
			);
			
			set(plugin[get(tooltipname)].url,'textfield.swf');
			set(plugin[get(tooltipname)].align,center);
			set(plugin[get(tooltipname)].autowidth,true);
			set(plugin[get(tooltipname)].autoheight,true);
			set(plugin[get(tooltipname)].vcenter,true);
			set(plugin[get(tooltipname)].background,false);
			set(plugin[get(tooltipname)].border,false);
			set(plugin[get(tooltipname)].css,'color:#FFFFFF');
			if(text == '' OR text === null,
				copy(plugin[get(tooltipname)].html,scene[get(linkedscene)].title),
				copy(plugin[get(tooltipname)].html,text)
			);
			set(plugin[get(tooltipname)].enabled,false);
			add_all_the_time_border();
		);
	</action>

	<!-- 热点上添加选中框 -->
	<action name="add_all_the_time_border">
		txtadd(bordername, 'border_', get(name));
		callwhen(!plugin[get(bordername)],
			addplugin(get(bordername));
			if(flag == 'hotspot',
				txtadd(plugin[get(bordername)].parent, 'hotspot[', get(name), ']'),
				txtadd(plugin[get(bordername)].parent, 'layer[', get(name), ']')
			);
			
			set(plugin[get(bordername)].url,'assets/imgs/hotspot_selected_bg.png');
			set(plugin[get(bordername)].keep, true);
			set(plugin[get(bordername)].visible, false);
			set(plugin[get(bordername)].edge, center);
			set(plugin[get(bordername)].align, center);
			set(plugin[get(bordername)].width, '110%');
			set(plugin[get(bordername)].height,'110%');
			set(plugin[get(bordername)].enabled,false);
		);
        
	</action>
</krpano>